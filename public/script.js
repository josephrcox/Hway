usernameArray = []
usernameColorArray = []
topicNameArray = []
topicPostCountArray = []
idArray = []
newPost_type = 1
posts = []
uploadedImageUrls = []
sorting = 1 // 1 is highest to lowest, 0 is lowest to highest
englishWordsArrayForRandomization = ["a","ability","able","about","above","accept","according","account","across","act","action","activity","actually","add","address","administration","admit","adult","affect","after","again","against","age","agency","agent","ago","agree","agreement","ahead","air","all","allow","almost","alone","along","already","also","although","always","American","among","amount","analysis","and","animal","another","answer","any","anyone","anything","appear","apply","approach","area","argue","arm","around","arrive","art","article","artist","as","ask","assume","at","attack","attention","attorney","audience","author","authority","available","avoid","away","baby","back","bad","bag","ball","bank","bar","base","be","beat","beautiful","because","become","bed","before","begin","behavior","behind","believe","benefit","best","better","between","beyond","big","bill","billion","bit","black","blood","blue","board","body","book","born","both","box","boy","break","bring","brother","budget","build","building","business","but","buy","by","call","camera","campaign","can","cancer","candidate","capital","car","card","care","career","carry","case","catch","cause","cell","center","central","century","certain","certainly","chair","challenge","chance","change","character","charge","check","child","choice","choose","church","citizen","city","civil","claim","class","clear","clearly","close","coach","cold","collection","college","color","come","commercial","common","community","company","compare","computer","concern","condition","conference","Congress","consider","consumer","contain","continue","control","cost","could","country","couple","course","court","cover","create","crime","cultural","culture","cup","current","customer","cut","dark","data","daughter","day","dead","deal","death","debate","decade","decide","decision","deep","defense","degree","Democrat","democratic","describe","design","despite","detail","determine","develop","development","die","difference","different","difficult","dinner","direction","director","discover","discuss","discussion","disease","do","doctor","dog","door","down","draw","dream","drive","drop","drug","during","each","early","east","easy","eat","economic","economy","edge","education","effect","effort","eight","either","election","else","employee","end","energy","enjoy","enough","enter","entire","environment","environmental","especially","establish","even","evening","event","ever","every","everybody","everyone","everything","evidence","exactly","example","executive","exist","expect","experience","expert","explain","eye","face","fact","factor","fail","fall","family","far","fast","father","fear","federal","feel","feeling","few","field","fight","figure","fill","film","final","finally","financial","find","fine","finger","finish","fire","firm","first","fish","five","floor","fly","focus","follow","food","foot","for","force","foreign","forget","form","former","forward","four","free","friend","from","front","full","fund","future","game","garden","gas","general","generation","get","girl","give","glass","go","goal","good","government","great","green","ground","group","grow","growth","guess","gun","guy","hair","half","hand","hang","happen","happy","hard","have","he","head","health","hear","heart","heat","heavy","help","her","here","herself","high","him","himself","his","history","hit","hold","home","hope","hospital","hot","hotel","hour","house","how","however","huge","human","hundred","husband","I","idea","identify","if","image","imagine","impact","important","improve","in","include","including","increase","indeed","indicate","individual","industry","information","inside","instead","institution","interest","interesting","international","interview","into","investment","involve","issue","it","item","its","itself","job","join","just","keep","key","kid","kill","kind","kitchen","know","knowledge","land","language","large","last","late","later","laugh","law","lawyer","lay","lead","leader","learn","least","leave","left","leg","legal","less","let","letter","level","lie","life","light","like","likely","line","list","listen","little","live","local","long","look","lose","loss","lot","love","low","machine","magazine","main","maintain","major","majority","make","man","manage","management","manager","many","market","marriage","material","matter","may","maybe","me","mean","measure","media","medical","meet","meeting","member","memory","mention","message","method","middle","might","military","million","mind","minute","miss","mission","model","modern","moment","money","month","more","morning","most","mother","mouth","move","movement","movie","Mr","Mrs","much","music","must","my","myself","name","nation","national","natural","nature","near","nearly","necessary","need","network","never","new","news","newspaper","next","nice","night","no","none","nor","north","not","note","nothing","notice","now","n't","number","occur","of","off","offer","office","officer","official","often","oh","oil","ok","old","on","once","one","only","onto","open","operation","opportunity","option","or","order","organization","other","others","our","out","outside","over","own","owner","page","pain","painting","paper","parent","part","participant","particular","particularly","partner","party","pass","past","patient","pattern","pay","peace","people","per","perform","performance","perhaps","period","person","personal","phone","physical","pick","picture","piece","place","plan","plant","play","player","PM","point","police","policy","political","politics","poor","popular","population","position","positive","possible","power","practice","prepare","present","president","pressure","pretty","prevent","price","private","probably","problem","process","produce","product","production","professional","professor","program","project","property","protect","prove","provide","public","pull","purpose","push","put","quality","question","quickly","quite","race","radio","raise","range","rate","rather","reach","read","ready","real","reality","realize","really","reason","receive","recent","recently","recognize","record","red","reduce","reflect","region","relate","relationship","religious","remain","remember","remove","report","represent","Republican","require","research","resource","respond","response","responsibility","rest","result","return","reveal","rich","right","rise","risk","road","rock","role","room","rule","run","safe","same","save","say","scene","school","science","scientist","score","sea","season","seat","second","section","security","see","seek","seem","sell","send","senior","sense","series","serious","serve","service","set","seven","several","sex","sexual","shake","share","she","shoot","short","shot","should","shoulder","show","side","sign","significant","similar","simple","simply","since","sing","single","sister","sit","site","situation","six","size","skill","skin","small","smile","so","social","society","soldier","some","somebody","someone","something","sometimes","son","song","soon","sort","sound","source","south","southern","space","speak","special","specific","speech","spend","sport","spring","staff","stage","stand","standard","star","start","state","statement","station","stay","step","still","stock","stop","store","story","strategy","street","strong","structure","student","study","stuff","style","subject","success","successful","such","suddenly","suffer","suggest","summer","support","sure","surface","system","table","take","talk","task","tax","teach","teacher","team","technology","television","tell","ten","tend","term","test","than","thank","that","the","their","them","themselves","then","theory","there","these","they","thing","think","third","this","those","though","thought","thousand","threat","three","through","throughout","throw","thus","time","to","today","together","tonight","too","top","total","tough","toward","town","trade","traditional","training","travel","treat","treatment","tree","trial","trip","trouble","true","truth","try","turn","TV","two","type","under","understand","unit","until","up","upon","us","use","usually","value","various","very","victim","view","violence","visit","voice","vote","wait","walk","wall","want","war","watch","water","way","we","weapon","wear","week","weight","well","west","western","what","whatever","when","where","whether","which","while","white","who","whole","whom","whose","why","wide","wife","will","win","wind","window","wish","with","within","without","woman","wonder","word","work","worker","world","worry","would","write","writer","wrong","yard","yeah","year","yes","yet","you","young","your","yourself"]
prevPageStr = "<a href='javascript:prevPage()' style='color: white; text-decoration: none;'> ⇐ </a>"
nextPageStr = "<a href='javascript:nextPage()' style='color: white; text-decoration: none;'> ⇒ </a>"
comment_count = []
commentParentPair = []
commentBodies = []
var lastClick = 0;
var delay = 400;

// Currents
cPage = 1
cTopic = ""
cID = ""

const postObject = {
    type: "",
    title: "",
    body: "",
    descDisplayed: "",
    total_votes: "",
    upvotes: "",
    downvotes: "",
    id: "",
    poster: "",
    date: "",
    link: "",
    topic: "",
    current_user_upvoted: "",
    current_user_downvoted: "",
    current_user_admin: "",
    comments: [],
    comment_count: "",

    display() {
        var postContainer = document.createElement("div")
        postContainer.setAttribute("class","postContainer")
        postContainer.setAttribute("id","postContainer_"+this.id)
        var postFrame = document.createElement("table")
        var voteFrame = document.createElement("table")
        postFrame.setAttribute("class", "postFrame")
        voteFrame.setAttribute("class", "voteFrame")
        postFrame.setAttribute("id", "postFrame_"+this.id)

        var voteDiv = document.createElement("div")
        voteDiv.setAttribute("id", "voteDiv_"+this.id)
        voteDiv.setAttribute("class", "voteDiv")

        var openPostButton = document.createElement("img")
        openPostButton.setAttribute("id", "openPostButton_"+this.id)
        openPostButton.setAttribute("class", "openPostButton")
        openPostButton.innerHTML = "<a href='/posts/"+this.id+"'></a>"
        openPostButton.src = '../assets/speech_bubble.png'
        openPostButton.onclick = function() {
            window.location.href = '/posts/'+this.id.substring(15)
        }   
        openPostButton.style.width = 'auto'

        var voteCount = document.createElement("div")
        voteCount.setAttribute("id","voteCount_"+this.id)
        voteCount.setAttribute("class","voteCount")
        voteCount.innerHTML = this.total_votes

        var voteUpButton = document.createElement("img")
        voteUpButton.setAttribute("id","voteUpButton_"+this.id)
        voteUpButton.setAttribute("class","voteUpButton")
        voteUpButton.src = '../assets/up.gif'
        if (this.current_user_upvoted && localStorage.getItem(this.id) == 1) {
            voteUpButton.src = '../assets/up_selected.gif'
        } 
        
        voteUpButton.style.width = 'auto'
        voteUpButton.onclick = function() {
            vote(1, this.id)
        }

        var voteDownButton = document.createElement("img")
        voteDownButton.setAttribute("id","voteDoButton_"+this.id)
        voteDownButton.setAttribute("class","voteDoButton")
        voteDownButton.src = '../assets/down.gif'
        if (this.current_user_downvoted && localStorage.getItem(this.id) == -1) {
            voteDownButton.src = '../assets/down_selected.gif'
        }
        voteDownButton.style.width = 'auto'
        voteDownButton.onclick = function() {
            vote(-1, this.id)
        }
         
        var title = postFrame.insertRow(0)
        var info = postFrame.insertRow(1)
        
        var titleCell = title.insertCell(0)
        var infoCell = info.insertCell(0)

        titleCell.setAttribute("id","titleCell_"+this.id)
        titleCell.setAttribute("class","titleCell")
        infoCell.setAttribute("id", "info_"+this.id)
        infoCell.setAttribute("class", "infoCell")

        var topHref = "\""+this.topic+"\""
        href = this.topic.replace(/^"(.*)"$/, '$1');
        infoCell.innerHTML = "Submitted by "+getUserColor(this.poster)+this.poster+"</span> in "+"<span style='color:blue; font-weight: 900;'><a href='/h/"+href+"'>"+this.topic+"</a></span>  on " +this.date

        var desc = postFrame.insertRow(2)
        var descCell = desc.insertCell(0)
        descCell.setAttribute("id","descCell_"+this.id)
        descCell.setAttribute("class", "descCell")

        titleCell.innerHTML = this.title

        if (this.type == "media") {
            var photo = document.createElement("img")
            photo.src = './image.jpg'
            descCell.innerHTML = "<img src='"+this.mediaURL+"'>"
            descCell.style.display = 'none'
            titleCell.innerHTML = "🖼        "+this.title+"<span style='font-size:12px'>        (+)</span>"
        }

        if (this.body != "(empty)") {
            descCell.innerHTML = this.body
            descCell.style.display = 'none'
            titleCell.innerHTML = this.title+"<span style='font-size:12px'>        (+)</span>"  
        } 

        if (this.type == "link") {
            let domain = (new URL(this.link));
            domain = domain.hostname.replace('www.','');
            titleCell.innerHTML = "🔗       <a href='" + this.link +"'>"+this.title+"</a> <span style='font-size: 10px'>("+domain+"...)</span>"
        }
        
        titleCell.onclick = function() {
            if (this.body != "(empty)") {
                expandDesc(this.id)
            } 
        }
    
        document.getElementById("postsArray").appendChild(postContainer)
        document.getElementById("postContainer_"+this.id).appendChild(postFrame)
        
        document.getElementById("postContainer_"+this.id).appendChild(voteDiv)
        document.getElementById("voteDiv_"+this.id).appendChild(voteCount)
        document.getElementById("voteDiv_"+this.id).appendChild(voteUpButton)
        document.getElementById("voteDiv_"+this.id).appendChild(voteDownButton)
        document.getElementById("voteDiv_"+this.id).appendChild(openPostButton)
    }
}

const commentObject = {
    body: "",
    id: "",
    total_votes: "",
    poster: "",
    posterID: "",
    date: "",

    display() {
        var comFrame = document.createElement("table")
        comFrame.setAttribute("class", "comFrame")
        comFrame.setAttribute("id", "comFrame_"+this.id)

        posterRow = comFrame.insertRow(0)
        posterRow.setAttribute("id", "posterRow_"+this.id)
        posterCell = posterRow.insertCell(0)
        infoRow = comFrame.insertRow(1)
        infoCell = infoRow.insertCell(0)
        infoCell.innerHTML = this.date
        infoCell.setAttribute("class","comInfoCell")
        bodyRow = comFrame.insertRow(2)
        bodyCell = bodyRow.insertCell(0)

        posterCell.innerHTML = getUserColor(this.poster)+this.poster + "</span> says: (-)"
        posterCell.setAttribute("id","posterCell_"+this.id)
        bodyCell.innerHTML = this.body
        bodyCell.setAttribute("class", "bodyCell")
        bodyCell.setAttribute("id", "bodyCell_"+this.id)

        posterRow.onclick = function() {
            var id = this.id.substring(10)
            var body = document.getElementById("bodyCell_"+id)
            var poster = document.getElementById("posterCell_"+id).innerHTML.split(" says")[0]
            if (body.innerHTML == "") {
                document.getElementById("posterCell_"+id).innerHTML = getUserColor(poster)+poster + "</span> says: (-)"
                body.innerHTML = commentBodies[comment_count.indexOf(parseInt(id))]
                console.log(id)
            } else {
                document.getElementById("posterCell_"+id).innerHTML = getUserColor(poster)+poster + "</span> says: (+)"
                var x = document.getElementById("bodyCell_"+this.id.substring(10))
                x.innerHTML = ""
            }
            
        }

        var voteDiv = document.createElement("div")
        voteDiv.setAttribute("id", "voteDiv_"+this.id)
        voteDiv.setAttribute("class", "comVoteDiv")

        var voteCount = document.createElement("div")
        voteCount.setAttribute("id","voteCount_"+this.id)
        voteCount.setAttribute("class","comVoteCount")
        voteCount.innerHTML = this.total_votes

        var voteUpButton = document.createElement("img")
        voteUpButton.setAttribute("id","voteUpButton_"+this.id)
        voteUpButton.setAttribute("class","voteUpButton")
        voteUpButton.src = '../assets/up.gif'
        voteUpButton.style.width = 'auto'
        voteUpButton.onclick = function() {
            vote(1, this.id)
        }

        var voteDownButton = document.createElement("img")
        voteDownButton.setAttribute("id","voteDoButton_"+this.id)
        voteDownButton.setAttribute("class","voteDoButton")
        voteDownButton.src = '../assets/down.gif'
        voteDownButton.style.width = 'auto'
        voteDownButton.onclick = function() {
            vote(-1, this.id)
        }

        document.getElementById("comments").appendChild(comFrame)
        document.getElementById("comFrame_"+this.id).appendChild(voteDiv)
        document.getElementById("voteDiv_"+this.id).appendChild(voteCount)
        document.getElementById("voteDiv_"+this.id).appendChild(voteUpButton)
        document.getElementById("voteDiv_"+this.id).appendChild(voteDownButton)
    }
}

const loadPosts = async (x, topic, page) => {
    if (topic == null || topic == "") {
        topic = "all"
    }
    if (window.location.href.indexOf("/h/") != -1) {
        console.log("topic page")
        url = window.location.href
        topic = url.split('/h/')[1]
        console.log(topic)
    } 
    if (window.location.href.indexOf("/posts/") != -1) { // on a specific post page, load only that one post & comments
        url = window.location.href
        postid = url.split('/posts/')[1]
        const response = await fetch('/api/get/posts/'+postid)
        const data = await response.json()
        document.getElementById("postsArray").innerHTML = ""

        let post = Object.create(postObject)
        post.title = data.title
        post.body = data.body
        if (post.body == "" || post.body == undefined || post.body == null) {
            post.body = "(empty)"
        }
        post.total_votes = data.total_votes
        post.upvotes = data.upvotes
        post.downvotes = data.downvotes
        post.id = data._id
        post.poster = data.poster
        post.date = data.date
        post.descDisplayed = false
        post.link = data.link
        post.type = data.type // 1=text, 2=link, 3=media
        post.topic = data.topic
        post.comment_count = data.comments.length
        post.comments = data.comments

        post.current_user_upvoted = data.current_user_upvoted
        post.current_user_downvoted = data.current_user_downvoted
        post.current_user_admin = data.current_user_admin

        posts.push(post)
        post.display()

        for (i=0;i<data.comments.length;i++) {
            console.log(data.comments[i])
            let com = Object.create(commentObject)
            com.body = data.comments[i].body
            com.id = data.comments[i]._id
            com.total_votes = data.comments[i].total_votes
            com.poster = data.comments[i].poster
            com.posterID = data.comments[i].posterID
            com.date = data.comments[i].date
            com.display()
            
            comment_count.push(com.id)
            commentParentPair.push(com.pid)
            commentBodies.push(com.body)
        }
        
        if (x != 0) {
            expandDesc(x)
        }
        topFunction()
        storeAndDisplayTopics()
        document.getElementById("commentSection").style.display = 'block'
        
    } else {
        const response = await fetch('/api/get/'+topic+'/'+page)
        const data = await response.json()
        console.log(data)

        document.getElementById("postsArray").innerHTML = ""

        for (i=0; i<data.length ; i++) {
            let post = Object.create(postObject)
            post.title = data[i].title
            post.body = data[i].body
            if (post.body == "" || post.body == undefined || post.body == null) {
                post.body = "(empty)"
            }
            post.total_votes = data[i].total_votes
            post.upvotes = data[i].upvotes
            post.downvotes = data[i].downvotes
            post.id = data[i]._id
            post.poster = data[i].poster
            post.date = data[i].date
            post.descDisplayed = false
            post.link = data[i].link
            post.type = data[i].type // 1=text, 2=link, 3=media
            post.topic = data[i].topic
            post.comment_count = data[i].comments.length
            post.comments = data[i].comments

            post.current_user_upvoted = data[i].current_user_upvoted
            post.current_user_downvoted = data[i].current_user_downvoted
            post.current_user_admin = data[i].current_user_admin

            posts.push(post)
            post.display()
        }
        
        if (x != 0) {
            expandDesc(x)
        }
        topFunction()
        storeAndDisplayTopics()
    }

    cTopic = topic
    console.log(cTopic)
    
}

function expandDesc(x) {
    y = "descCell"+x.substring(9)
    title = document.getElementById(x).innerHTML.replace('<span style="font-size:12px">        (+)</span>', '').replace('<span style="font-size:12px">        (-)</span>','')
    if (document.getElementById(y).innerHTML != "" && document.getElementById(y).innerHTML != null) {
        if (document.getElementById(y).style.display == 'block') {
            document.getElementById(y).style.display = 'none'
            document.getElementById(x).innerHTML = title + "<span style='font-size:12px'>        (+)</span>"
        } else {
            document.getElementById(y).style.display = 'block'
            document.getElementById(x).innerHTML = title + "<span style='font-size:12px'>        (-)</span>"
        }
    }
}

const loadUsersFromServer = async () => {
    const response = await fetch('/api/get/users')
    const data = await response.json()

    for (i=0; i<data.length ; i++) {
        usernameArray.push(data[i].name)
        idArray.push(data[i]._id)
    }
    if (usernameArray.length == 0) {
        localStorage.clear()
    }

    brightness = 2
    for (i=0;i<usernameArray.length;i++) {
        color = '#'+(0x1000000+Math.random()*0xffffff).toString(16).substr(1,6)
        var rgb = [Math.random() * 256, Math.random() * 256, Math.random() * 256];
        var mix = [brightness*51, brightness*51, brightness*51]; //51 => 255/5
        var mixedrgb = [rgb[0] + mix[0], rgb[1] + mix[1], rgb[2] + mix[2]].map(function(x){ return Math.round(x/2.0)})
        usernameColorArray[i] = "rgb(" + mixedrgb.join(",") + ")";
    }
}

const storeAndDisplayTopics = async () => {
    document.getElementById("topic-dropdown").innerHTML = ""
    const response = await fetch('/api/get/topics/')
    var data = await response.json()

    if (data.length > 10) {
        topics = 10
    } else {
        topics = data.length
    }
    for (j=0;j<topics;j++) {
        var newTopic = document.createElement('a')
        href = data[j][0].replace(/^"(.*)"$/, '$1');
        newTopic.innerHTML = "<a href='/h/"+href+"'>"+data[j][0]+"("+data[j][1]+")</a>"
        document.getElementById("topic-dropdown").appendChild(newTopic)
    }
}

const vote = async (d, y) => { 
    if (lastClick >= (Date.now() - delay)) {
        return;
    }
    lastClick = Date.now();
    id = y
    change = d // 1 is upvote, -1 is downvote
    hasVoted = localStorage.getItem(id.substring(13)) // null if no, 1 if up, -1 if down

    const settings = {
        method: 'PUT',
    };

    if (hasVoted == 1) { // has upvoted
        if (change == 1) {
        } else { // downvoting
            if (id != null) {
                if (document.getElementById("voteUpButton_"+id.substring(13)).src.includes('assets/up_selected.gif')) {
                    document.getElementById("voteUpButton_"+id.substring(13)).src = '../assets/up.gif'
                } else {
                    document.getElementById("voteDoButton_"+id.substring(13)).src = '../assets/down_selected.gif'
                }
                localStorage.removeItem(id.substring(13))
                oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
                document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount-1
                const fetchResponse = await fetch('/vote/'+id+'/'+change, settings); 
                
            }
        }
    } else if (hasVoted == -1) { // has downvoted
        if (change == -1) {
        } else { // upvoting
            if (id != null) {
                if (document.getElementById("voteDoButton_"+id.substring(13)).src.includes('assets/down_selected.gif')) {
                    document.getElementById("voteDoButton_"+id.substring(13)).src = '../assets/down.gif'
                } else {
                    document.getElementById("voteUpButton_"+id.substring(13)).src = '../assets/up_selected.gif'
                }
                localStorage.removeItem(id.substring(13))
                oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
                document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount+1
                const fetchResponse = await fetch('/vote/'+id+'/'+change, settings); 
                const data = await fetchResponse.json()
            }
        }
    } else if (hasVoted == null) { // has not voted
        if (id != null) {
            localStorage.setItem(id.substring(13), change)
            oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
            document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount+change
            const fetchResponse = await fetch('/vote/'+id+'/'+change, settings); 
            const data = await fetchResponse.json()
            console.log(data)
            if (change == 1) {
                document.getElementById("voteDoButton_"+id.substring(13)).src = '../assets/down.gif'
                document.getElementById("voteUpButton_"+id.substring(13)).src = '../assets/up_selected.gif'
            } else {
                document.getElementById("voteDoButton_"+id.substring(13)).src = '../assets/down_selected.gif'
                document.getElementById("voteUpButton_"+id.substring(13)).src = '../assets/up.gif'
            }
        }
    }
}

// const voteCom = async (d, id) => { 
//     change = d // 1 is upvote, -1 is downvote
//     hasVoted = localStorage.getItem(id.substring(13)) // null if no, 1 if up, -1 if down
    
//     index = comment_count.indexOf(id.substring(13))
//     pid = commentParentPair[index]
//     const settings = {
//         method: 'PUT',
//     };

//     if (hasVoted == 1) { // has upvoted
//         if (change == 1) {
//         } else {
//             if (id != null) {
//                 const fetchResponse = await fetch('/voteCom/'+id+'/'+pid+'/'+change, settings); 
//                 localStorage.removeItem(id.substring(13))
//                 oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
//                 document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount-1
//             }
//         }
//     } else if (hasVoted == -1) { // has downvoted
//         if (change == -1) {
//         } else {
//             if (id != null) {
//                 const fetchResponse = await fetch('/voteCom/'+id+'/'+pid+'/'+change, settings); 
//                 localStorage.removeItem(id.substring(13))
//                 oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
//                 document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount+1
//             }
//         }
//     } else if (hasVoted == null) { // has not voted
//         if (id != null) {
//             const fetchResponse = await fetch('/voteCom/'+id+'/'+pid+'/'+change, settings); 
//             localStorage.setItem(id.substring(13), change)
//             oldCount = parseInt(document.getElementById("voteCount_"+id.substring(13)).innerHTML)
//             document.getElementById("voteCount_"+id.substring(13)).innerHTML = oldCount+change
//         }
//     }
// }

const comment = async (postid, body) => { 
    if (body != null && body != "") {
        bodyJSON = {
            "id":postid,
            "body":body,
        }
    
        const fetchResponse = await fetch('/api/post/comment/', {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
                },
            method: 'POST',
            body: JSON.stringify(bodyJSON)
        }); 
        var data = await fetchResponse.json()

        let com = Object.create(commentObject)
        com.body = data.body
        com.id = data._id
        com.pid = data.parent
        com.total_votes = data.total_votes
        com.uptotal_votes = data.uptotal_votes
        com.downtotal_votes = data.downtotal_votes
        com.poster = data.poster

        comment_count.push(com.id)
        commentParentPair.push(com.pid)
        // com.display()
    }
}

function ui_newPost() {
    if (document.getElementById("newPost_div").style.display == 'block') {
        document.getElementById("newPost_div").style.display = 'none'
        document.getElementById("post-button").innerHTML = "Create new post"
        document.getElementById("newPost_logs").innerHTML = ""
        document.getElementById("newPost_topic").value = cTopic
    } else {
        document.getElementById("newPost_div").style.display = 'block'
        document.getElementById("post-button").innerHTML = "Collapse"
        document.getElementById("newPost_topic").value = cTopic
    }
}

function launch() { 
    document.getElementById("newPost_div").style.display = 'none'
    document.getElementById("newPost_logs").innerHTML = ""
    cPage = 1
    prevPage()
    document.getElementById("page-number").innerHTML = prevPageStr+"Page "+cPage+nextPageStr
    loadPosts(0, "", 1)
}

document.getElementById("newPost_submit_button").onclick = function() {
    topic = (document.getElementById("newPost_topic").value).replace(" ","")
    postTitle = document.getElementById("newPost_name").value
    if (topic == "" || topic == null || topic == undefined) {
        topic = "all"
    }

    switch (newPost_type) {
        case 1: // Text
            postDesc = document.getElementById("newPost_desc").value
            
            if (postTitle == "" || postTitle == null || !postTitle.replace(/\s/g, '').length) {
                document.getElementById("newPost_logs").innerHTML = "Please enter title"
            } else {
                createNewPost()
            }
            break;
        case 2: // Link
            postHref = document.getElementById("newPost_link").value

            if (postTitle == "" || postTitle == null) {
                document.getElementById("newPost_logs").innerHTML = "Please enter title"
            } else {
                if (postHref.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g) != null) {
                    if (usernameArray.includes(poster)) {
                        index = usernameArray.indexOf(poster)
                        if (localStorage.getItem(idArray[index]) == "true") {
                            postLink(postTitle, postHref, poster, true, topic)
                        } else {
                            postLink(postTitle, postHref, poster, false, topic)
                        }
                    } else {
                        postLink(postTitle, postHref, poster, true, topic)
                    }
                } else {
                    document.getElementById("newPost_logs").innerHTML = "Please enter valid URL"
                }
            }
            break;
        case 3: // Media
            poster = document.getElementById("newPost_user").value

            if (postTitle == "" || postTitle == null) {
                document.getElementById("newPost_logs").innerHTML = "Please enter title"
            } else {
                if (usernameArray.includes(poster)) {
                    index = usernameArray.indexOf(poster)
                    if (document.getElementById("newPost_file").value == "" ) { // no file uploaded
                        document.getElementById("newPost_logs").innerHTML = "Please upload file"
                    } else {
                        if (localStorage.getItem(idArray[index]) == "true") {
                            postMedia(postTitle, poster, true, topic)
                        } else {
                            postMedia(postTitle, poster, false, topic)
                        }
                    }
                } else {
                    postMedia(postTitle, poster, true, topic)
                }
            }
            break;

    }
    
}

document.getElementById("newPost_type_text").onclick = function() {
    newPost_type = 1;
    document.getElementById("newPost_type_text").style.backgroundColor = "lightgreen"
    document.getElementById("newPost_type_link").style.backgroundColor = ""
    document.getElementById("newPost_type_media").style.backgroundColor = ""

    document.getElementById("newPost_desc").style.display = "block"
    document.getElementById("newPost_desc_label").style.display = "block"
    document.getElementById("newPost_link").style.display = "none"
    document.getElementById("newPost_link_label").style.display = "none"
    document.getElementById("newPost_file").style.display = "none"
    document.getElementById("newPost_file_label").style.display = "none"
    document.getElementById("newPost_submit_button").style.display = "block"
}

document.getElementById("newPost_type_link").onclick = function() {
    newPost_type = 2;
    document.getElementById("newPost_type_text").style.backgroundColor = ""
    document.getElementById("newPost_type_link").style.backgroundColor = "lightgreen"
    document.getElementById("newPost_type_media").style.backgroundColor = ""

    document.getElementById("newPost_link").style.display = "block"
    document.getElementById("newPost_link_label").style.display = "block"
    document.getElementById("newPost_desc").style.display = "none"
    document.getElementById("newPost_desc_label").style.display = "none"
    document.getElementById("newPost_file").style.display = "none"
    document.getElementById("newPost_file_label").style.display = "none"
    document.getElementById("newPost_submit_button").style.display = "block"
}

document.getElementById("newPost_type_media").onclick = function() {
    newPost_type = 3;
    document.getElementById("newPost_type_text").style.backgroundColor = ""
    document.getElementById("newPost_type_link").style.backgroundColor = ""
    document.getElementById("newPost_type_media").style.backgroundColor = "lightgreen"

    document.getElementById("newPost_desc").style.display = "none"
    document.getElementById("newPost_desc_label").style.display = "none"
    document.getElementById("newPost_link").style.display = "none"
    document.getElementById("newPost_link_label").style.display = "none"
    document.getElementById("newPost_file").style.display = "block"
    document.getElementById("newPost_file_label").style.display = "block"
    document.getElementById("newPost_submit_button").style.display = "none"
}

document.getElementById("newCom_submit").onclick = function() {
    commentContent = document.getElementById("newCom_body").value
    comment(cID, commentContent)

    document.getElementById("newCom_body").value = ""
}

function postRandomly() {
    amountOfWords = Math.floor(Math.random() * 20)
    posterLengthInWords = Math.floor(Math.random() * 4)
    bodyBoolean = Math.floor(Math.random() * 2) // 0 if no, 1 if yes
    bodyLengthInWords = Math.floor(Math.random() * 200)
    titleStr = ""
    posterStr = ""
    bodyStr = ""
    topicStr = ""

    for (i=0;i<amountOfWords;i++) {
        titleStr += englishWordsArrayForRandomization[Math.floor(Math.random() * 995) + 5]+" "
    }
    for (i=0;i<posterLengthInWords;i++) {
        posterStr += englishWordsArrayForRandomization[Math.floor(Math.random() * 1000)]
    }
    if (bodyBoolean == 1 || bodyBoolean == "1") {
        for (i=0;i<bodyLengthInWords;i++) {
            bodyStr += englishWordsArrayForRandomization[Math.floor(Math.random() * 1000)]+" "
        }
    } else {
        bodyStr = ""
    }

    topicStr = englishWordsArrayForRandomization[Math.floor(Math.random() * 1000)]

    postText(titleStr, bodyStr, posterStr, true, topicStr)
}

const createNewPost = async() => {
    title = document.getElementById("newPost_name").value
    body = document.getElementById("newPost_desc").value
    topic = document.getElementById("newPost_topic").value
    if (topic == "" || topic == null) {
        topic = "all"
    }

    bodyJSON = {
        "title":title,
        "body":body,
        "topic":topic
    }
    const fetchResponse = await fetch('/api/post/post', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 
    const data = await fetchResponse.json()

    console.log(data.code)
    document.getElementById("newPost_name").innerHTML = ""
    document.getElementById("newPost_desc").innerHTML = ""
    document.getElementById("newPost_topic").innerHTML = ""
    if (data.code == 200) {
        window.location.reload()
    }
    
}

const postText = async (x, y, z, usernameValid, topic) => { 
    if (z == null || z == "") {
        z = "zzdj"
    }

    password = document.getElementById("newPost_pw").value

    bodyJSON = {
        "title":x,
        "body":y,
        "poster":z,
        "usernameValid":usernameValid,
        "password":password,
        "topic":topic
    }

    const fetchResponse = await fetch('/post', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 

    if (fetchResponse.status == '406') {
        document.getElementById("newPost_logs").innerHTML = "Name taken by other user."
    } else {
        storeUserID(true)
        
        document.getElementById("newPost_name").value = ""
        document.getElementById("newPost_desc").value = ""
        document.getElementById("newPost_logs").innerHTML = ""
    }
}

const postLink = async (x, y, z, usernameValid, topic) => { 
    if (z == null || z == "") {
        z = "zzdj"
    }

    password = document.getElementById("newPost_pw").value

    bodyJSON = {
        "title":x,
        "link":y,
        "poster":z,
        "usernameValid":usernameValid,
        "password":password,
        "topic":topic
    }

    const fetchResponse = await fetch('/post/link', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 

    if (fetchResponse.status == '406') {
        document.getElementById("newPost_logs").innerHTML = "Name taken by other user."
    } else {
        storeUserID(true)
        
        document.getElementById("newPost_name").value = ""
        document.getElementById("newPost_desc").value = ""
        document.getElementById("newPost_logs").innerHTML = ""
    }
}

const postMedia = async (x, z, usernameValid, topic) => { 
    if (z == null || z == "") {
        z = "zzdj"
    }
    url = uploadedImageUrls.pop()

    password = document.getElementById("newPost_pw").value

    bodyJSON = {
        "title":x,
        "poster":z,
        "usernameValid":usernameValid,
        "password":password,
        "src":url,
        "topic":topic
    }

    const fetchResponse = await fetch('/post/media', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 

    if (fetchResponse.status == '406') {
        document.getElementById("newPost_logs").innerHTML = "Name taken by other user."
    } else {
        storeUserID(true)
        
        document.getElementById("newPost_name").value = ""
        document.getElementById("newPost_desc").value = ""
        document.getElementById("newPost_file").value = ""
        document.getElementById("newPost_logs").innerHTML = ""
    }
}

document.getElementById('newPost_file').addEventListener("change", ev => {
    const formdata = new FormData()
    formdata.append("image", ev.target.files[0])
    uploadImage(formdata)
})

const uploadImage = async (x) => { 
    document.getElementById("newPost_logs").innerHTML = "Uploading..."
    const fetchResponse = await fetch('https://api.imgbb.com/1/upload?key=e23bc3a1c5f2ec99cc1aa7676dc0f3fb', {
        method: 'POST',
        body: x
    })
    const data = await fetchResponse.json();
    const url = (JSON.stringify(data.data.display_url)).replace(/["]+/g, '')
    uploadedImageUrls.push(url)
    
    document.getElementById("newPost_submit_button").style.display = "block"
    document.getElementById("newPost_logs").innerHTML = ""
}

function getUserColor(x) {
    index = usernameArray.indexOf(x)
    randomColor = usernameColorArray[index] 
    return "<span style='color:"+ randomColor+"; font-weight: 900;'>"
}

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}

function topFunction() {
    window.scrollTo({top: 0, behavior: 'smooth'});  
}

function prevPage() {
    if (cPage == 1) {
        return 
    }
    document.getElementById("page-number").innerHTML = ""
    cPage -= 1
    loadPosts(0, cTopic, cPage)
    document.getElementById("page-number").innerHTML = prevPageStr+"Page "+cPage+nextPageStr
}

function nextPage() {
    document.getElementById("page-number").innerHTML = ""
    cPage += 1
    loadPosts(0, cTopic, cPage)
    document.getElementById("page-number").innerHTML = prevPageStr+"Page "+cPage+nextPageStr
}