<div class="login-reg">
    <h1 style='color:black'>Reset password</h1>
        <form id="reg-form">
            <input type="text" autocomplete="off" id="username" name="name" placeholder="username" /><br/>
            <input type="email" autocomplete="off" id="email" name="email" placeholder="email" /><br/>
            <input type="submit" value="Send code"/>
        </form>
        <div id='logs'></div>
        <form id="code-form" style="display:none;">
            <input type="text" autocomplete="off" id="code" name="code" placeholder="code" /><br/>
            <input type="submit" value="Check code"/>
        </form>

        <form id="reset-form" style="display:none;">
            <input type="password" autocomplete="off" id="newpassword" name="newpassword" placeholder="New Password" /><br/>
            <input type="submit" value="Submit"/>
        </form>
</div>
<script>

let u
let e


document.getElementsByClassName('header-buttons')[0].style.display = 'none'
document.getElementById('sorting_options').style.display = 'none'

document.getElementById("header-notifs-bell").style.display = 'none'

const sendCode = async(event) => {
    event.preventDefault()
    u = document.getElementById('username').value
    e = document.getElementById('email').value
    console.log(u,e)

    let bodyJSON = {
        "email":e,
        "username":u
    }
    
    const fetchResponse = await fetch('/api/post/resetpassword/sendcode', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 
    var data = await fetchResponse.json()

    if (data.status == "error") {
        document.getElementById('logs').innerHTML = data.data
    } else if (data.status == "ok") {
        document.getElementById('reg-form').style.display = 'none'
        document.getElementById('code-form').style.display = 'block'
        document.getElementById('logs').innerHTML = ''
    }
}

const checkCode = async(event) => {
    event.preventDefault()
    
    let code = document.getElementById('code').value
    console.log(e,u, code)

    const response = await fetch('/api/get/resetpassword/checkcode/'+u+'/'+code)
    const data = await response.json()

    if (data.status == "ok") {
        console.log("woo! logging in! ")
        document.getElementById('code-form').style.display = 'none'
        document.getElementById('reset-form').style.display = 'block'
    } else {
        document.getElementById("logs").innerHTML = data.data
    }

}

const resetpw = async(event) => {
    event.preventDefault()
    pw = document.getElementById('newpassword').value

    let bodyJSON = {
        "password":pw
    }
    
    const fetchResponse = await fetch('/api/put/account/setpassword', {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
        method: 'POST',
        body: JSON.stringify(bodyJSON)
    }); 
    var data = await fetchResponse.json()

    if (data.status == "error") {
        document.getElementById('logs').innerHTML = data.data
    } else if (data.status == "ok") {
        document.getElementById('logs').innerHTML = "done"
    }
}

const form = document.getElementById("reg-form")
form.addEventListener('submit', sendCode)

const codeform = document.getElementById("code-form")
codeform.addEventListener('submit', checkCode)

const resetform = document.getElementById("reset-form")
resetform.addEventListener('submit', resetpw)

</script>